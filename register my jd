@router.post("/user", response_model=UserResponse)
def create_user(data: UserCreate, db: SessionDep):
    # Check if user already exists
    statement = select(User).where(User.username == data.username)
    existing_user = db.exec(statement).first()

    if existing_user:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="User already exists"
        )

    # Create user
    user = User(
        username=data.username,
        hashed_password=get_password_hash(data.password),
        first_name=data.first_name,
        last_name=data.last_name,
        department_code=data.department_code,
        role="user"
    )

    db.add(user)
    db.commit()
    db.refresh(user)

    # Activity log
    db.add(
        ActivityLog(
            username=user.username,
            action="register",
            details={},
            status="success"
        )
    )
    db.commit()

    return user